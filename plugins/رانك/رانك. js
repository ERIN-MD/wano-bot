import { createHash } from 'crypto';
import { canLevelUp, xpRange } from '../lib/levelling.js';

let handler = async (m, { conn, usedPrefix, command }) => {
  let who = m.quoted ? m.quoted.sender : (m.mentionedJid && m.mentionedJid[0]) ? m.mentionedJid[0] : (m.fromMe ? conn.user.jid : m.sender);

  if (!(who in global.db.data.users)) {
    throw 'âœ³ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
  }

  let pp = await conn.profilePictureUrl(who, 'image').catch(_ => './Guru.jpg');
  let user = global.db.data.users[who];
  let about = (await conn.fetchStatus(who).catch(console.error) || {}).status || '';
  let { name, exp, credit, lastclaim, registered, regTime, age, level, role, wealth, warn } = global.db.data.users[who];
  let { min, xp, max } = xpRange(user.level, global.multiplier);
  let username = conn.getName(who);
  let math = max - xp;
  let prem = global.prems.includes(who.split`@`[0]);
  let sn = createHash('md5').update(who).digest('hex');

  let happyEmoji = 'ğŸ‰'; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¥Ù„Ù‰ Ù…Ø§ ØªÙØ¶Ù„Ù‡
  let happyMessage = 'Ø§ØªÙØ¶Ù„  ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒğŸ®';
  // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù…Ù„Ø© Ø¥Ù„Ù‰ Ù…Ø§ ØªÙØ¶Ù„Ù‡

  let str = `*${happyEmoji} Ø§Ù„Ø§Ø³Ù…:* ${username}${about ? '\n\n âœ¨ *Ø§Ù„ÙˆØµÙ:* ' + about : ''}\n\n*ğŸ“Š Ø§Ù„Ù…Ø³ØªÙˆÙ‰:* ${level}\n*Ù†Ù‚Ø§Ø·ÙƒğŸ’²*: ${exp}\n*Ø§Ù„ØªÙ‚Ø¯Ù…* (${user.exp - min} / ${xp})\n${math <= 0 ? `Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø±ØªÙ‚Ø§Ø¡ Ø¨Ù…Ø³ØªÙˆØ§Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… *${usedPrefix}levelup* ${happyEmoji}` : `*Ø§Ù†Øª ØªØ­ØªØ§Ø¬* ${math} *Ù†Ù‚Ø·Ø© Ù„Ø±ÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ* ${happyEmoji}`}\n*ğŸ“ˆ Ø±ØªØ¨ØªÙƒ:* ${role}\n*ğŸ’ Ø§Ù„Ù…Ø§Ø³Ùƒ*: ${user.limit}\n*ğŸ‘‘ Ø´Ø®Øµ Ù…Ù…ÙŠØ²*: ${prem ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}\n*_Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚âœ”ï¸_* ${sn}\nÂ«â›©ï¸â”ƒğŸ®WONOğŸ®â”ƒâ›©ï¸Â»\n\n${happyMessage}`;

  conn.sendFile(m.chat, pp, 'profil.jpg', str, m, false, { mentions: [who] });
};

handler.help = ['profile'];
handler.tags = ['group'];
handler.command = ['Ø±Ø§Ù†Ùƒ'];

export default handler;
